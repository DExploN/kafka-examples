# Пример работы с партициями в Apache Kafka

Этот пример демонстрирует работу с конкретными партициями в Apache Kafka вместо использования автоматического распределения сообщений (round-robin).

## Описание

В данном примере показано, как:
1. Отправлять сообщения в конкретные партиции на основе ключа
2. Читать сообщения из определенной партиции

## Файлы примера

- **producer.php** - отправляет сообщения в конкретные партиции на основе хеша ключа
- **consumer.php** - читает сообщения из указанной партиции
- **create-topic.sh** - скрипт для создания топика с несколькими партициями

## Функциональность

### Продюсер (producer.php)

- Определение партиции на основе хеша ключа сообщения
- Отправка сообщений в конкретные партиции
- Логирование информации о распределении сообщений по партициям

### Консьюмер (consumer.php)

- Чтение сообщений из конкретной партиции (указывается как аргумент командной строки)
- Обработка сообщений только из указанной партиции
- Возможность запуска нескольких экземпляров для чтения из разных партиций

## Сценарий использования

Этот пример подходит для:
- Систем, где требуется сохранение порядка сообщений для определенных ключей
- Приложений, где нужно гарантировать, что сообщения с одинаковым ключом всегда попадают в одну партицию
- Случаев, когда необходимо распределить нагрузку между несколькими консьюмерами, каждый из которых обрабатывает свою партицию

## Подготовка

Перед запуском примера необходимо создать топик с несколькими партициями:

```bash
# Создание топика с 3 партициями
./create-topic.sh
```

## Запуск примера

### Запуск продюсера
```bash
docker exec -it kafka_examples_php php /var/www/html/examples/partitioned/producer.php
```

### Запуск консьюмера для чтения из конкретной партиции
```bash
# Чтение из партиции 0 (по умолчанию)
docker exec -it kafka_examples_php php /var/www/html/examples/partitioned/consumer.php

# Чтение из партиции 1
docker exec -it kafka_examples_php php /var/www/html/examples/partitioned/consumer.php 1

# Чтение из партиции 2
docker exec -it kafka_examples_php php /var/www/html/examples/partitioned/consumer.php 2
```

## Отличия от других примеров

В отличие от базовых и продвинутых примеров, этот пример:
- Работает с конкретными партициями вместо автоматического распределения
- Использует хеширование ключей для определения партиции
- Демонстрирует чтение из конкретной партиции вместо подписки на весь топик
- Показывает, как можно распределить обработку между несколькими консьюмерами на уровне партиций

## Технические детали

### Как работает распределение по партициям

1. Для каждого ключа вычисляется хеш (используется функция crc32)
2. Хеш преобразуется в положительное число
3. Берется остаток от деления на количество партиций (модуль)
4. Полученное число используется как номер партиции

Таким образом, сообщения с одинаковым ключом всегда попадают в одну и ту же партицию, что гарантирует сохранение порядка для каждого ключа.
