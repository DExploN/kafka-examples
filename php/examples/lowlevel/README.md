# Пример использования низкоуровневого API Apache Kafka в PHP

Этот пример демонстрирует работу с Apache Kafka через низкоуровневый API `RdKafka\Consumer` вместо высокоуровневого `RdKafka\KafkaConsumer`.

## Описание

В данном примере показано, как:
1. Отправлять сообщения в Kafka с использованием стандартного продюсера
2. Читать сообщения из Kafka с использованием низкоуровневого API `RdKafka\Consumer`
3. Вручную управлять смещениями (offsets) без использования групп потребителей

## Файлы примера

- **producer.php** - отправляет сообщения в топик Kafka
- **consumer.php** - читает сообщения из указанной партиции с использованием низкоуровневого API
- **create-topic.sh** - скрипт для создания топика с несколькими партициями

## Разница между RdKafka\Consumer и RdKafka\KafkaConsumer

### RdKafka\Consumer (Низкоуровневый API)

**Особенности:**
- Прямой доступ к партициям через методы `consumeStart()`, `consume()` и `consumeStop()`
- Нет встроенного механизма управления смещениями (offsets)
- Нет автоматической балансировки нагрузки между потребителями
- Нет понятия групп потребителей
- Требует ручного управления смещениями (сохранение и восстановление)

**Методы работы:**
- `consumeStart($partition, $offset)` - начинает потребление из указанной партиции с определенного смещения
- `consume($partition, $timeout_ms)` - читает одно сообщение из указанной партиции
- `consumeStop($partition)` - останавливает потребление из указанной партиции

**Преимущества:**
- Более точный контроль над чтением из партиций
- Возможность чтения с произвольного смещения
- Меньше накладных расходов на координацию между потребителями
- Подходит для простых сценариев или когда требуется низкоуровневый доступ

**Недостатки:**
- Требует ручного управления смещениями
- Нет автоматической балансировки нагрузки
- Нет отказоустойчивости при выходе из строя потребителя
- Более сложный в использовании

### RdKafka\KafkaConsumer (Высокоуровневый API)

**Особенности:**
- Поддержка групп потребителей
- Автоматическое управление смещениями
- Автоматическая балансировка нагрузки между потребителями
- Поддержка механизма ребалансировки при добавлении или удалении потребителей

**Методы работы:**
- `subscribe([topics])` - подписывается на указанные топики, Kafka автоматически распределяет партиции
- `assign([topic_partitions])` - явно назначает потребителю конкретные партиции
- `consume($timeout_ms)` - читает сообщения из всех назначенных партиций
- `commit($message)` - фиксирует смещение для сообщения
- `close()` - закрывает потребителя и освобождает ресурсы

**Преимущества:**
- Автоматическое управление смещениями
- Автоматическая балансировка нагрузки
- Отказоустойчивость
- Проще в использовании для большинства сценариев

**Недостатки:**
- Меньший контроль над чтением из партиций
- Дополнительные накладные расходы на координацию между потребителями
- Может быть избыточным для простых сценариев

## Когда использовать низкоуровневый API

Низкоуровневый API (`RdKafka\Consumer`) рекомендуется использовать в следующих случаях:

1. **Специфические требования к чтению** - когда нужен точный контроль над тем, из какой партиции и с какого смещения читать
2. **Простые сценарии** - когда нет необходимости в сложной координации между потребителями
3. **Специальные инструменты** - для создания утилит мониторинга, отладки или администрирования
4. **Производительность** - когда критична производительность и нужно минимизировать накладные расходы
5. **Собственная реализация управления смещениями** - когда нужно реализовать собственную логику сохранения и восстановления смещений

## Подготовка

Перед запуском примера необходимо создать топик:

```bash
# Создание топика с 3 партициями
./create-topic.sh
```

## Запуск примера

### Запуск продюсера
```bash
docker exec -it kafka_examples_php php /var/www/html/examples/lowlevel/producer.php
```

### Запуск консьюмера для чтения из конкретной партиции
```bash
# Чтение из партиции 0 (по умолчанию)
docker exec -it kafka_examples_php php /var/www/html/examples/lowlevel/consumer.php

# Чтение из партиции 1
docker exec -it kafka_examples_php php /var/www/html/examples/lowlevel/consumer.php 1

# Чтение из партиции 2
docker exec -it kafka_examples_php php /var/www/html/examples/lowlevel/consumer.php 2
```

## Особенности реализации

В данном примере для сохранения смещений используется файловая система, а не встроенный механизм Kafka:

1. При получении сообщения, его смещение сохраняется в файл
2. При запуске консьюмера, он проверяет наличие сохраненного смещения и начинает чтение с этой позиции
3. При завершении работы (включая Ctrl+C), последнее смещение также сохраняется

Это демонстрирует, как можно реализовать собственный механизм управления смещениями при использовании низкоуровневого API.

## Сравнение с другими примерами

- **basic** - использует высокоуровневый API с автоматическим распределением партиций
- **advanced** - использует высокоуровневый API с ООП-подходом и расширенной функциональностью
- **partitioned** - использует высокоуровневый API с явным назначением партиций
- **lowlevel** (этот пример) - использует низкоуровневый API с ручным управлением партициями и смещениями
