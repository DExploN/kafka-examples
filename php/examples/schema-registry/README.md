# Пример использования Apache Kafka с Schema Registry и Avro в PHP

В этой директории находятся примеры использования Apache Kafka с PHP с применением Schema Registry и формата Avro для сериализации сообщений.

## Файлы примеров

- **producer.php** - пример отправки сообщений в Kafka с использованием Avro и Schema Registry
- **second-producer.php** - пример отправки сообщений с использованием существующей схемы из Schema Registry
- **producer-with-new-schema.php** - пример обновления схемы и отправки сообщений с новой версией схемы
- **consumer.php** - пример чтения сообщений из Kafka с десериализацией Avro и поддержкой разных версий схем

## Описание

Этот пример демонстрирует использование Schema Registry и формата Avro для сериализации и десериализации сообщений в Kafka. Avro - это бинарный формат сериализации данных, который обеспечивает компактное представление данных и строгую типизацию. Schema Registry - это сервис, который хранит схемы Avro и обеспечивает совместимость между различными версиями схем.

### Продюсер (producer.php)

Скрипт `producer.php` отправляет несколько сообщений в топик Kafka, сериализуя их с использованием Avro и регистрируя схему в Schema Registry.

#### Функциональность продюсера:
- Определение Avro схемы для сообщений
- Подключение к Schema Registry
- Автоматическая регистрация схемы в Schema Registry
- Сериализация сообщений с использованием Avro
- Отправка сериализованных сообщений в топик `avro-test-topic`
- Логирование процесса отправки сообщений

### Второй продюсер (second-producer.php)

Скрипт `second-producer.php` демонстрирует более реалистичный сценарий использования Schema Registry, когда схема уже зарегистрирована и продюсер получает её из реестра, а не определяет локально.

#### Функциональность второго продюсера:
- Подключение к Schema Registry
- Получение последней версии схемы из реестра через REST API
- Сериализация сообщений с использованием полученной схемы
- Отправка сериализованных сообщений в топик `avro-test-topic`
- Логирование процесса отправки сообщений

#### Преимущества использования существующей схемы:
- Централизованное управление схемами
- Отсутствие дублирования схем в коде
- Гарантия использования актуальной версии схемы
- Упрощение поддержки и обновления схем

### Продюсер с новой версией схемы (producer-with-new-schema.php)

Скрипт `producer-with-new-schema.php` демонстрирует эволюцию схемы и обратную совместимость в Schema Registry. Он получает существующую схему, добавляет новое поле и регистрирует обновленную версию схемы.

#### Функциональность продюсера с новой схемой:
- Подключение к Schema Registry
- Получение последней версии схемы из реестра
- Модификация схемы (добавление нового поля `work`)
- Регистрация новой версии схемы в Schema Registry
- Сериализация сообщений с использованием обновленной схемы
- Отправка сериализованных сообщений в топик `avro-test-topic`
- Логирование процесса отправки сообщений

#### Особенности эволюции схемы:
- Добавление нового поля с указанием значения по умолчанию для обратной совместимости
- Сохранение всех существующих полей и их типов
- Регистрация как новой версии существующей схемы, а не как новой схемы

### Консьюмер (consumer.php)

Скрипт `consumer.php` читает сообщения из топика Kafka и десериализует их с использованием схемы из Schema Registry. Он поддерживает обратную совместимость и может обрабатывать сообщения разных версий схемы.

#### Функциональность консьюмера:
- Подключение к Schema Registry
- Чтение сообщений из топика `avro-test-topic`
- Десериализация сообщений с использованием Avro и схемы из Schema Registry
- Определение версии схемы сообщения (старая или новая)
- Обработка полей в зависимости от версии схемы
- Вывод десериализованных данных
- Логирование полученных сообщений

## Автоматическая регистрация схем

Во всех примерах используется автоматическая регистрация схем в Schema Registry. Это реализовано с помощью следующих опций при создании сериализатора:

```php
$recordSerializer = new RecordSerializer($registry, [
    RecordSerializer::OPTION_REGISTER_MISSING_SUBJECTS => true,
    RecordSerializer::OPTION_REGISTER_MISSING_SCHEMAS => true
]);
```

Эти опции позволяют:
- **OPTION_REGISTER_MISSING_SUBJECTS** - автоматически регистрировать новые субъекты (subjects) в Schema Registry, если они не существуют
- **OPTION_REGISTER_MISSING_SCHEMAS** - автоматически регистрировать новые схемы в Schema Registry, если они не существуют

Это упрощает работу с Schema Registry, особенно при первом запуске, когда схемы еще не зарегистрированы.

## Nullable поля в Avro

В примере используется nullable поле `title`, которое может принимать значение null или строку. В Avro nullable поля определяются как union типы с включением типа "null":

```json
{"name": "title", "type": ["null", "string"], "default": null}
```

### Особенности nullable полей:
- Определяются как union типы с "null" в качестве одного из вариантов
- Могут иметь значение null или значение указанного типа (в нашем случае string)
- Часто используются для опциональных полей
- Требуют указания default значения (обычно null) для обратной совместимости

### Использование в примерах:
- В `producer.php` отправляются сообщения с разными значениями поля title (null и не-null)
- В `second-producer.php` также демонстрируется работа с nullable полем
- В `consumer.php` показана обработка nullable поля с проверкой на null

## Эволюция схем и обратная совместимость

Одним из ключевых преимуществ использования Schema Registry является возможность эволюции схем с сохранением обратной совместимости. В этом примере демонстрируется, как можно обновить схему, добавив новое поле, и при этом обеспечить корректную обработку как старых, так и новых сообщений.

### Принципы обратной совместимости в Avro

Для обеспечения обратной совместимости при эволюции схем в Avro необходимо соблюдать следующие правила:

1. **Добавление новых полей** - Новые поля должны иметь значения по умолчанию, чтобы старые сообщения могли быть десериализованы с новой схемой.
2. **Сохранение существующих полей** - Нельзя удалять существующие поля или менять их типы несовместимым образом.
3. **Использование nullable полей** - Для полей, которые могут отсутствовать, следует использовать union типы с null.

### Реализация в примере

В нашем примере:

1. `producer.php` создает и регистрирует исходную схему с полями `id`, `content`, `timestamp` и `title`.
2. `producer-with-new-schema.php` получает эту схему, добавляет новое поле `work` с пустой строкой в качестве значения по умолчанию и регистрирует обновленную версию схемы.
3. `consumer.php` может обрабатывать сообщения обеих версий схемы, проверяя наличие поля `work` и отображая соответствующую информацию.

Это демонстрирует, как Schema Registry позволяет эволюционировать схемы данных без нарушения работы существующих продюсеров и консьюмеров.

## Преимущества использования Schema Registry и Avro

1. **Строгая типизация данных** - Avro обеспечивает строгую типизацию данных, что помогает избежать ошибок при обработке сообщений.
2. **Эволюция схем** - Schema Registry позволяет управлять версиями схем и обеспечивает совместимость между различными версиями.
3. **Компактность** - Avro обеспечивает компактное бинарное представление данных, что уменьшает объем передаваемых данных.
4. **Самоописываемость** - Сообщения содержат ссылку на схему, что позволяет автоматически десериализовать их без предварительного знания схемы.
5. **Поддержка nullable полей** - Avro позволяет определять nullable поля, что делает схемы более гибкими и удобными для реальных сценариев использования.
6. **Обратная совместимость** - Возможность обновлять схемы с сохранением совместимости со старыми сообщениями.

## Настройка окружения

Для работы примера необходимы следующие сервисы:
- Apache Kafka
- Zookeeper
- Schema Registry

Все эти сервисы уже настроены в docker-compose.yml файле проекта.

## Запуск примеров

### Запуск всех сервисов

```bash
docker-compose up -d
```

### Установка зависимостей PHP

```bash
docker exec -it kafka_examples_php composer install
```

### Запуск продюсера

```bash
docker exec -it kafka_examples_php php /var/www/html/examples/schema-registry/producer.php
```

### Запуск второго продюсера

```bash
# Сначала нужно запустить первый продюсер, чтобы зарегистрировать схему
docker exec -it kafka_examples_php php /var/www/html/examples/schema-registry/producer.php

# Затем запустить второй продюсер, который будет использовать зарегистрированную схему
docker exec -it kafka_examples_php php /var/www/html/examples/schema-registry/second-producer.php
```

### Запуск продюсера с новой версией схемы

```bash
# Сначала нужно запустить первый продюсер, чтобы зарегистрировать исходную схему
docker exec -it kafka_examples_php php /var/www/html/examples/schema-registry/producer.php

# Затем запустить продюсер с новой версией схемы, который обновит схему и добавит поле "work"
docker exec -it kafka_examples_php php /var/www/html/examples/schema-registry/producer-with-new-schema.php
```

### Запуск консьюмера

```bash
docker exec -it kafka_examples_php php /var/www/html/examples/schema-registry/consumer.php
```

### Демонстрация обратной совместимости

Для демонстрации обратной совместимости и эволюции схем рекомендуется выполнить следующие шаги:

1. Запустить `producer.php` для отправки сообщений с исходной схемой
2. Запустить `consumer.php` в отдельном терминале и убедиться, что сообщения успешно десериализуются
3. Запустить `producer-with-new-schema.php` для обновления схемы и отправки сообщений с новой схемой
4. Наблюдать в консьюмере, как он успешно обрабатывает сообщения обеих версий схемы
5. Запустить снова `producer.php` для отправки сообщений со старой схемой
6. Убедиться, что консьюмер по-прежнему успешно обрабатывает все сообщения

Это демонстрирует, как Schema Registry обеспечивает обратную совместимость при эволюции схем.

## Просмотр схем в Schema Registry

Вы можете просмотреть зарегистрированные схемы через REST API Schema Registry или через веб-интерфейс AKHQ.

### Через REST API

```bash
# Получить список всех субъектов (subjects)
curl -X GET http://localhost:8081/subjects

# Получить последнюю версию схемы для конкретного субъекта
curl -X GET http://localhost:8081/subjects/avro-test-topic-value/versions/latest
```

### Через веб-интерфейс AKHQ

1. Откройте в браузере http://localhost:8080
2. Перейдите в раздел "Schema Registry"
3. Вы увидите список всех зарегистрированных схем и сможете просмотреть их содержимое
